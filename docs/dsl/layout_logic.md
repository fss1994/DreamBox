# DreamBox的布局逻辑

## 0. 设计启发

DreamBox的布局逻辑受Android的约束布局启发，基本思想等同于约束布局。如果开发者对约束布局比较了解，相信一定能够更加快速得进入状态。DB在后续的迭代中不会保证完全符合约束布局的逻辑，并且不追求完全支持约束布局所提供的所有特性。所以，具体的DB布局逻辑需要以此文档中描述的为准。

附：[Android官方约束布局介绍](https://developer.android.google.cn/training/constraint-layout)

## 1. 基础概念

### 1.1 X轴、Y轴、Z轴

视图元素在横向上的排布为X轴：

<img src="../assets/layout_logic_1.png" style="zoom:20%;" />

视图元素在竖向上的排布为Y轴：

<img src="../assets/layout_logic_2.png" style="zoom:20%;" />

视图元素的层层覆盖关系可以理解为Z轴：

<img src="../assets/layout_logic_3.png" style="zoom:20%;" />

如上图所示，C在Z轴上的顺序最为优先。对于DSL来说，每个视图元素的声明顺序（行号）即为其最终视图展示的Z轴顺序。以上图为例，在DSL中应是先声明了A，后B，最后是C。

### 1.2 基准对象

假定已有视图元素A被放置在了画布的（0，0）处（左上角）：

<img src="../assets/layout_logic_4.png" style="zoom:20%;" />

新增视图元素B，在不允许直接指定坐标的情况下，要让B放置在画布上，那么一定需要依赖于画布上已有的元素作为基准元素，B与其产生相对位置关系才可以成功放置。

假如，我们想将B放置在A的下方，抽象理解上应该是：

<img src="../assets/layout_logic_5.png" style="zoom:20%;" />

中间的箭头意为：B的顶端坐标依赖于A的底端坐标，即B在Y轴上依赖于A的位置。（暂时忽略B的X轴关系，认为会默认居左）。

#### 1.2.1 parent

在上边，我们是通过假定确定了A可以是在画布的左上角。但实际上，在布局逻辑中认为画布本身也是一个抽象的视图元素，名为：`parent`，所以A可以置于画布左上角的布局逻辑实际上是因为：

<img src="../assets/layout_logic_6.png" style="zoom:20%;" />

（暂时忽略A与布局边界的间距尺寸）

### 1.3 约束

一个视图对象至少有一个基准对象，至多两个。并且在X轴和Y轴上都（分别）和基准对象有“关系”，才能构成一个合法的布局逻辑。这个关系就叫做**约束关系**。

<img src="../assets/layout_logic_7.png" style="zoom:20%;" />

如上图中，A是B的基准对象，B向A的左端对齐（X轴），B在A之下（Y轴）。三个元素（X轴、Y轴、基准元素）齐备，B的布局逻辑合理。在DSL中，如`leftToLeft`、`rightToRight`等为控制X轴的约束属性，`topToTop`、`bottomToBottom`等为控制Y轴的约束属性

## 2. 复杂约束示例

<img src="../assets/layoug_logic_8.png" style="zoom:20%;" />

上图中有三个视图元素A、B、C：

1. A在X、Y轴上以画布（parent）为基准对象定位在了左上角
2. B以A为基准对象，顶端与其顶端对齐（`topToTop`），左边以其右边为基准（`leftToRight`），视觉上定位在了A的右侧
3. C较为特殊，其有两个基准对象。在X轴上以B为基准对象，左边与B的左边对齐（`leftToLeft`），在Y轴上以A为基准对象，上边以A的底边为基准（`topToBottom`）。视觉上定位在画布的右下角

## 3. 约束关系与尺寸的共同作用

> 这里所说的“尺寸”指的是`width`或`height`

### 3.1 尺寸的可选值

- `fill` 铺满父布局所允许的最大空间。是由外向内的测量机制
- `wrap` 自适应。对于不同的视图元素，其意义可能不同。如`text`是根据字数内容自动测量宽高，但对于`view`来说`wrap`的宽高都会是0。对于开发者自行扩展的布局，也要注意妥善处理`wrap`属性的尺寸测量机制。设计上，`wrap`应是由内向外的测量机制
- 非0指定值。开发者指定的像素或适配尺寸值，明确指定相关视图的宽高
- 0。表示此视图的尺寸由约束关系确定

### 3.2 基础理念

1. 尺寸决定了视图元素在画布中的大小
2. 约束关系决定了视图元素在画布中的位置（坐标）
3. 除了0之外的尺寸值都是视图自行决定大小，与约束无关
4. 0是在视图元素的（所有）基准对象的位置确定后，再对此视图元素进行尺寸规定的一个case。可以简单的理解为，0可等价于其基准对象的具体位置所计算得出的具体尺寸作为非0指定值设置给该视图元素的尺寸

### 3.3 应用穷举

> 下边的应用场景中会假设A的布局位置已经确定，B以A为基准对象

#### 3.3.1 fill+约束

假设是在X轴上`fill`，那么会在宽度上对齐父布局进行充满。其在X轴上的约束关系生效但不会影响其宽度。

<img src="../assets/layout_logic_9.png" style="zoom:35%;" />

注：

1. 红色边框表示画布的实际尺寸
2. B在宽度上因为`fill`的存在会撑满
3. B的`rightToRight`即使不给也没有关系，因为X轴上已经有了`leftToLeft`

#### 3.3.2 wrap+约束

<img src="../assets/layout_logic_10.png" style="zoom:30%;" />

我们看宽度。B会按照自己的规则在X轴向上自动测量尺寸。与其基准对象A的左边界进行对齐。

若此时加入X轴上的右侧约束`rightToRight`：

<img src="../assets/layout_logic_11.png" style="zoom:30%;" />

因为左右对同一基准产生了约束，所以会自动寻求中值，最终的效果是在X轴上与A的中线对齐。（Y轴上是同样的布局原理）

#### 3.3.3 非0指定值+约束

同wrap。

#### 3.3.4 0+约束

0表示此视图布局严格遵循约束关系为其限定的尺寸：

<img src="../assets/layout_logic_12.png" style="zoom:30%;" />

在X轴上，B与A的左右产生约束关系，同时宽度width声明为0，即：告诉布局系统它的宽度完全由约束关系决定。结果是，B的宽度会完全跟随A的宽度。（Y轴上是同样的布局原理）